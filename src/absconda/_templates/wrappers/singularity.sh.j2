#!/bin/bash
# Auto-generated by absconda wrap
# Image: {{ image_ref }}
# Command: {{ command }}
set -euo pipefail

{% if image_cache %}
SIF_CACHE="{{ image_cache }}"
{% else %}
SIF_CACHE="${HOME}/.local/absconda/sif-cache"
{% endif %}
SIF_FILE="${SIF_CACHE}/{{ sif_filename }}"
IMAGE_REF="docker://{{ image_ref }}"

# Pull SIF if missing
if [[ ! -f "$SIF_FILE" ]]; then
    mkdir -p "$SIF_CACHE"
    echo "Pulling Singularity image to cache..." >&2
    singularity pull "$SIF_FILE" "$IMAGE_REF"
fi

# Build mount arguments
MOUNTS=()
{% for mount in mounts %}
MOUNTS+=("-B" "{{ mount }}")
{% endfor %}

{% if gpu %}
# GPU support
GPU_FLAG="--nv"
{% else %}
GPU_FLAG=""
{% endif %}

# Execute command in container
exec singularity exec \
    $GPU_FLAG \
    "${MOUNTS[@]}" \
    "$SIF_FILE" \
    {{ command }} "$@"
